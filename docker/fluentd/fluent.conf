<source>
  @type syslog
  @label @unbound
  bind 0.0.0.0
  port 5140
  protocol_type udp
  format none
  tag unbound.log
  <parse>
    @type regexp
    expression query: (?<client>\S+) (?<host>\S+)\. (?<record_type>\S+) IN$
  </parse>
</source>

<label @unbound>
  # <filter **.daemon.info>
  #   @type geoip
  #   geoip_lookup_keys host
  #   backend_library geoip2_c
  #   <record>
  #     city            ${city.names.en["host"]}
  #     latitude        ${location.latitude["host"]}
  #     longitude       ${location.longitude["host"]}
  #     country         ${country.iso_code["host"]}
  #     country_name    ${country.names.en["host"]}
  #   </record>
  #   skip_adding_null_record true
  #   @log_level info
  # </filter>

  <filter unbound.log.**>
    @type stdout
  </filter>

  <match **.daemon.info>
    @type copy

    <store>
      @type exec_filter
      tag exec.unbound
      command python3 /geoip.py
      child_respawn inf
      <format>
        @type json
      </format>
      <parse>
        @type json
      </parse>
      <buffer>
        @type memory
        retry_max_times 0
        chunk_limit_records 100
      </buffer>
    </store>

    <store>
      @type elasticsearch
      host elasticsearch
      port 9200
      type_name unbound
      include_tag_key true
      tag_key @log_name
      logstash_format true
      logstash_prefix unbound
      flush_interval 10s
    </store>
  </match>
</label>
